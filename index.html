<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>IP-Tracker üòà - Nachrichten</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 600px; margin: 2rem auto; padding: 0 1rem; }
    input, button { padding: 0.5rem; font-size: 1rem; margin: 0.5rem 0; width: 100%; }
    ul { padding-left: 1.2rem; }
    li { margin-bottom: 0.5rem; background: #f0f0f0; padding: 0.5rem; border-radius: 4px; }
    #user-link { word-break: break-word; display: block; margin-bottom: 1rem; }
    #logout { margin-top: 1rem; }
  </style>
</head>
<body>

  <h1>üëÅÔ∏è Willkommen</h1>

  <div id="auth">
    <input type="email" id="email" placeholder="Deine E-Mail" autocomplete="email" />
    <button id="btn-login">Anmelden / Registrieren (Magic Link)</button>
  </div>

  <div id="user-info" style="display:none;">
    <p>üë§ Eingeloggt als: <span id="user-email"></span></p>
    <p>üîó Dein Nachrichten-Link zum Teilen:</p>
    <a href="#" id="user-link" target="_blank" rel="noopener noreferrer">Lade Link...</a>

    <h2>üì¨ Deine Nachrichten</h2>
    <ul id="messages-list"></ul>

    <button id="logout">Logout</button>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

    const supabaseUrl = 'https://wxvpqpmmqlwogevypndw.supabase.co'
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind4dnBxcG1tcWx3b2dldnlwbmR3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkxMTQxMDQsImV4cCI6MjA2NDY5MDEwNH0.t7HsLa7ZS1OBUtvLiM5IStAwMZjqy_WZ2B-s2SYn32I'
    const supabase = createClient(supabaseUrl, supabaseKey)

    const authDiv = document.getElementById('auth')
    const userInfoDiv = document.getElementById('user-info')
    const emailInput = document.getElementById('email')
    const btnLogin = document.getElementById('btn-login')
    const logoutBtn = document.getElementById('logout')
    const userEmailSpan = document.getElementById('user-email')
    const userLink = document.getElementById('user-link')
    const messagesList = document.getElementById('messages-list')

    async function showUser(user) {
      authDiv.style.display = 'none'
      userInfoDiv.style.display = 'block'
      userEmailSpan.textContent = user.email

      const link = `${window.location.origin}/Nachricht/?to=${user.id}`
      userLink.href = link
      userLink.textContent = link

      await loadMessages(user)
    }

    async function loadMessages(user) {
      const { data, error } = await supabase
        .from('messages')
        .select('text, created_at')
        .eq('to_user_id', user.id)
        .order('created_at', { ascending: false })

      messagesList.innerHTML = ''

      if (error) {
        console.error('Fehler beim Laden der Nachrichten:', error)
        messagesList.innerHTML = '<li>Fehler beim Laden der Nachrichten.</li>'
        return
      }

      if (!data.length) {
        messagesList.innerHTML = '<li>Keine Nachrichten gefunden.</li>'
        return
      }

      for (const msg of data) {
        const li = document.createElement('li')
        const date = new Date(msg.created_at).toLocaleString('de-DE', { dateStyle: 'short', timeStyle: 'short' })
        li.textContent = `${date}: ${msg.text}`
        messagesList.appendChild(li)
      }
    }

    btnLogin.addEventListener('click', async () => {
      const email = emailInput.value.trim()
      if (!email) return alert('Bitte E-Mail eingeben.')

      const { error } = await supabase.auth.signInWithOtp({ email })
      if (error) {
        alert('Fehler beim Senden des Login-Links: ' + error.message)
        return
      }
      alert('Login-Link wurde an deine E-Mail gesendet. Bitte √ºberpr√ºfe dein Postfach.')
    })

    logoutBtn.addEventListener('click', async () => {
      await supabase.auth.signOut()
      authDiv.style.display = 'block'
      userInfoDiv.style.display = 'none'
      emailInput.value = ''
      messagesList.innerHTML = ''
      userEmailSpan.textContent = ''
      userLink.href = '#'
      userLink.textContent = 'Lade Link...'
    })

    async function checkSession() {
      const { data: { session } } = await supabase.auth.getSession()
      if (session?.user) {
        showUser(session.user)
      } else {
        authDiv.style.display = 'block'
        userInfoDiv.style.display = 'none'
      }
    }

    checkSession()

    supabase.auth.onAuthStateChange((_event, session) => {
      if (session?.user) {
        showUser(session.user)
      } else {
        authDiv.style.display = 'block'
        userInfoDiv.style.display = 'none'
      }
    })
  </script>
</body>
</html>

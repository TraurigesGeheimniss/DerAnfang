<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Nachrichten-Portal</title>
  <style>
    body { font-family: sans-serif; margin: 2em; }
    input, textarea { width: 100%; max-width: 400px; margin: 5px 0; padding: 8px; }
    button { margin: 10px 0; padding: 10px; }
    #messages p { border-bottom: 1px solid #ccc; padding: 4px 0; }
  </style>
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

    const supabase = createClient(
      'https://wxvpqpmmqlwogevypndw.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind4dnBxcG1tcWx3b2dldnlwbmR3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkxMTQxMDQsImV4cCI6MjA2NDY5MDEwNH0.t7HsLa7ZS1OBUtvLiM5IStAwMZjqy_WZ2B-s2SYn32I'
    )

    async function checkUser() {
      const { data: { session } } = await supabase.auth.getSession()
      const user = session?.user

      if (user) {
        document.getElementById('auth-section').style.display = 'none'
        document.getElementById('app-section').style.display = 'block'
        showPersonalLink(user.id)
        loadMessages(user.id)
      } else {
        document.getElementById('auth-section').style.display = 'block'
        document.getElementById('app-section').style.display = 'none'
      }
    }

    async function loadMessages(userId) {
      const { data, error } = await supabase
        .from('messages')
        .select('text, created_at')
        .eq('to_user_id', userId)
        .order('created_at', { ascending: false })

      const container = document.getElementById('messages')
      container.innerHTML = ''

      if (error) {
        container.textContent = 'Fehler beim Laden der Nachrichten.'
        return
      }

      if (!data || data.length === 0) {
        container.textContent = 'Keine Nachrichten vorhanden.'
        return
      }

      data.forEach(msg => {
        const p = document.createElement('p')
        p.textContent = `${new Date(msg.created_at).toLocaleString()}: ${msg.text}`
        container.appendChild(p)
      })
    }

    function showPersonalLink(userId) {
      const url = `${window.location.origin}/message.html?to=${userId}`
      document.getElementById('personal-link').innerHTML = `
        <p>Dein Link:</p>
        <input id="link" value="${url}" readonly />
        <button onclick="navigator.clipboard.writeText('${url}')">Kopieren</button>
      `
    }

    async function signUp(event) {
      event.preventDefault()
      const email = document.getElementById('signup-email').value
      const password = document.getElementById('signup-password').value

      const { error } = await supabase.auth.signUp({
        email,
        password
      }, {
        redirectTo: `${window.location.origin}/index.html`
      })

      if (error) {
        alert('Fehler bei Registrierung: ' + error.message)
      } else {
        alert('Registrierung erfolgreich â€“ bitte E-Mail bestÃ¤tigen.')
      }
    }

    async function signIn(event) {
      event.preventDefault()
      const email = document.getElementById('login-email').value
      const password = document.getElementById('login-password').value

      const { error } = await supabase.auth.signInWithPassword({ email, password })

      if (error) {
        alert('Login fehlgeschlagen: ' + error.message)
      } else {
        await checkUser()
      }
    }

    async function signOut() {
      await supabase.auth.signOut()
      await checkUser()
    }

    window.onload = checkUser
    window.signUp = signUp
    window.signIn = signIn
    window.signOut = signOut
  </script>
</head>
<body>
  <h1>ðŸ§¾ Dein Nachrichten-Link</h1>

  <section id="auth-section">
    <h2>Login</h2>
    <form onsubmit="signIn(event)">
      <input id="login-email" type="email" placeholder="E-Mail" required />
      <input id="login-password" type="password" placeholder="Passwort" required />
      <button type="submit">Anmelden</button>
    </form>

    <h2>Registrieren</h2>
    <form onsubmit="signUp(event)">
      <input id="signup-email" type="email" placeholder="E-Mail" required />
      <input id="signup-password" type="password" placeholder="Passwort" required />
      <button type="submit">Registrieren</button>
    </form>
  </section>

  <section id="app-section" style="display: none;">
    <button onclick="signOut()">Abmelden</button>
    <div id="personal-link"></div>
    <h2>ðŸ“¬ Deine Nachrichten</h2>
    <div id="messages">Lade...</div>
  </section>
</body>
</html>
